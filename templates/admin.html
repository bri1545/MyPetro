<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ú–æ–π –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50">
    {{template "header" .}}
    
    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-orange-600">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ ({{len .ModerationProjects}})</h2>
            {{if .ModerationProjects}}
                <div class="grid gap-4">
                    {{range .ModerationProjects}}
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-2">{{.Title}}</h3>
                            <p class="text-gray-700 mb-4">{{.Description}}</p>
                            <div class="grid md:grid-cols-2 gap-4 text-sm mb-4">
                                <div><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{.Category}}</div>
                                <div><strong>–†–∞–π–æ–Ω:</strong> {{.District}}</div>
                                <div><strong>–ë—é–¥–∂–µ—Ç:</strong> {{.Budget}} ‚Ç∏</div>
                                <div><strong>–ì–æ–ª–æ—Å–æ–≤:</strong> {{.VoteCount}}</div>
                            </div>
                            
                            {{if .AIAnalysis}}
                            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-900 mb-2">ü§ñ –ê–Ω–∞–ª–∏–∑ –ò–ò-—Å–æ–≤–µ—Ç–Ω–∏–∫–∞:</h4>
                                <div id="ai-analysis-{{.ID}}" data-analysis="{{.AIAnalysis}}"></div>
                                <script>
                                    (function() {
                                        try {
                                            const element = document.getElementById('ai-analysis-{{.ID}}');
                                            const analysisData = element.getAttribute('data-analysis');
                                            const analysis = JSON.parse(analysisData);
                                            let html = '';
                                            
                                            if (analysis.pros && analysis.pros.length > 0) {
                                                html += '<div class="mb-3"><strong class="text-green-700">‚úì –ü–ª—é—Å—ã:</strong><ul class="list-disc ml-5 mt-1">';
                                                analysis.pros.forEach(pro => {
                                                    const escapedPro = pro.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                                    html += '<li class="text-sm text-gray-700">' + escapedPro + '</li>';
                                                });
                                                html += '</ul></div>';
                                            }
                                            
                                            if (analysis.cons && analysis.cons.length > 0) {
                                                html += '<div><strong class="text-red-700">‚úó –ú–∏–Ω—É—Å—ã:</strong><ul class="list-disc ml-5 mt-1">';
                                                analysis.cons.forEach(con => {
                                                    const escapedCon = con.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                                    html += '<li class="text-sm text-gray-700">' + escapedCon + '</li>';
                                                });
                                                html += '</ul></div>';
                                            }
                                            
                                            element.innerHTML = html;
                                        } catch(e) {
                                            document.getElementById('ai-analysis-{{.ID}}').innerHTML = '<p class="text-sm text-gray-500">–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
                                        }
                                    })();
                                </script>
                            </div>
                            {{end}}
                            
                            <form hx-post="/admin/update-status" hx-swap="none" class="space-y-4">
                                <input type="hidden" name="project_id" value="{{.ID}}">
                                <div>
                                    <label class="block text-sm font-medium mb-2">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                                    <select name="status" required class="w-full px-4 py-2 border rounded-lg" onchange="toggleDates(this, {{.ID}})">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                        <option value="voting">–û–¥–æ–±—Ä–∏—Ç—å –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</option>
                                        <option value="rejected">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</option>
                                    </select>
                                </div>
                                
                                <div id="dates-{{.ID}}" class="hidden grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">–ù–∞—á–∞–ª–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:</label>
                                        <input type="datetime-local" name="vote_start" class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">–ö–æ–Ω–µ—Ü –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:</label>
                                        <input type="datetime-local" name="vote_end" class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                                    <textarea name="comment" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∞–≤—Ç–æ—Ä–∞"></textarea>
                                </div>
                                
                                <div class="flex gap-4">
                                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                                    </button>
                                    <button type="button" onclick="toggleEdit({{.ID}})" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                                    </button>
                                </div>
                            </form>
                            
                            <div id="edit-form-{{.ID}}" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞:</h4>
                                <form hx-post="/admin/edit-project" hx-swap="none" class="space-y-4">
                                    <input type="hidden" name="project_id" value="{{.ID}}">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                                        <input type="text" name="title" value="{{.Title}}" class="w-full px-4 py-2 border rounded-lg" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                                        <textarea name="description" rows="4" class="w-full px-4 py-2 border rounded-lg" required>{{.Description}}</textarea>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                                            <select name="category" class="w-full px-4 py-2 border rounded-lg" required>
                                                <option value="–û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ" {{if eq .Category "–û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ"}}selected{{end}}>–û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</option>
                                                <option value="–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" {{if eq .Category "–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"}}selected{{end}}>–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                                                <option value="–°–∫–≤–µ—Ä—ã" {{if eq .Category "–°–∫–≤–µ—Ä—ã"}}selected{{end}}>–°–∫–≤–µ—Ä—ã</option>
                                                <option value="–ö—É–ª—å—Ç—É—Ä–∞" {{if eq .Category "–ö—É–ª—å—Ç—É—Ä–∞"}}selected{{end}}>–ö—É–ª—å—Ç—É—Ä–∞</option>
                                                <option value="–£—Ä–±–∞–Ω–∏—Å—Ç–∏–∫–∞" {{if eq .Category "–£—Ä–±–∞–Ω–∏—Å—Ç–∏–∫–∞"}}selected{{end}}>–£—Ä–±–∞–Ω–∏—Å—Ç–∏–∫–∞</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">–†–∞–π–æ–Ω:</label>
                                            <input type="text" name="district" value="{{.District}}" class="w-full px-4 py-2 border rounded-lg" required>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">–ë—é–¥–∂–µ—Ç (‚Ç∏):</label>
                                        <input type="number" name="budget" value="{{.Budget}}" min="1" class="w-full px-4 py-2 border rounded-lg" required>
                                    </div>
                                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                    </button>
                                </form>
                            </div>
                        </div>
                    {{end}}
                </div>
            {{else}}
                <p class="text-gray-600">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</p>
            {{end}}
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-blue-600">–ù–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ ({{len .VotingProjects}})</h2>
            {{if .VotingProjects}}
                <div class="grid gap-4">
                    {{range .VotingProjects}}
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-2">{{.Title}}</h3>
                            <div class="text-sm mb-4">
                                <strong>–ì–æ–ª–æ—Å–æ–≤:</strong> {{.VoteCount}} | <strong>–ë—é–¥–∂–µ—Ç:</strong> {{.Budget}} ‚Ç∏
                            </div>
                            
                            <form hx-post="/admin/update-status" hx-swap="none" class="space-y-4">
                                <input type="hidden" name="project_id" value="{{.ID}}">
                                <div class="flex gap-4">
                                    <button type="submit" name="status" value="selected" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                        ‚úì –ü—Ä–æ–µ–∫—Ç –ø–æ–±–µ–¥–∏–ª
                                    </button>
                                    <button type="submit" name="status" value="rejected" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                                        ‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                    </button>
                                </div>
                                <textarea name="comment" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                            </form>
                        </div>
                    {{end}}
                </div>
            {{else}}
                <p class="text-gray-600">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏</p>
            {{end}}
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-600">–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ ({{len .SelectedProjects}})</h2>
            {{if .SelectedProjects}}
                <div class="grid gap-4">
                    {{range .SelectedProjects}}
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-2">{{.Title}}</h3>
                            <div class="text-sm mb-4">
                                <strong>–ì–æ–ª–æ—Å–æ–≤:</strong> {{.VoteCount}} | <strong>–ë—é–¥–∂–µ—Ç:</strong> {{.Budget}} ‚Ç∏
                            </div>
                            
                            <form hx-post="/admin/update-status" hx-swap="none" class="space-y-4">
                                <input type="hidden" name="project_id" value="{{.ID}}">
                                <button type="submit" name="status" value="in_progress" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700">
                                    –ù–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
                                </button>
                                <textarea name="comment" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–∞—á–∞–ª–µ —Ä–∞–±–æ—Ç"></textarea>
                            </form>
                        </div>
                    {{end}}
                </div>
            {{else}}
                <p class="text-gray-600">–ù–µ—Ç –ø–æ–±–µ–¥–∏–≤—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
            {{end}}
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-orange-600">–í —Ä–∞–±–æ—Ç–µ ({{len .InProgressProjects}})</h2>
            {{if .InProgressProjects}}
                <div class="grid gap-4">
                    {{range .InProgressProjects}}
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-2">{{.Title}}</h3>
                            <div class="text-sm mb-4">
                                <strong>–ë—é–¥–∂–µ—Ç:</strong> {{.Budget}} ‚Ç∏
                            </div>
                            
                            <form hx-post="/admin/update-status" hx-swap="none" class="space-y-4">
                                <input type="hidden" name="project_id" value="{{.ID}}">
                                <button type="submit" name="status" value="done" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                    ‚úì –ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
                                </button>
                                <textarea name="comment" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç"></textarea>
                            </form>
                        </div>
                    {{end}}
                </div>
            {{else}}
                <p class="text-gray-600">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ</p>
            {{end}}
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ ({{len .DoneProjects}})</h2>
            {{if .DoneProjects}}
                <div class="grid gap-4">
                    {{range .DoneProjects}}
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-2">{{.Title}}</h3>
                            <div class="text-sm">
                                <strong>–ë—é–¥–∂–µ—Ç:</strong> {{.Budget}} ‚Ç∏ | <strong>–ì–æ–ª–æ—Å–æ–≤:</strong> {{.VoteCount}}
                            </div>
                        </div>
                    {{end}}
                </div>
            {{else}}
                <p class="text-gray-600">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
            {{end}}
        </div>
    </main>
    
    <script>
        function toggleDates(select, projectId) {
            const datesDiv = document.getElementById('dates-' + projectId);
            if (select.value === 'voting') {
                datesDiv.classList.remove('hidden');
            } else {
                datesDiv.classList.add('hidden');
            }
        }
        
        function toggleEdit(projectId) {
            const editForm = document.getElementById('edit-form-' + projectId);
            editForm.classList.toggle('hidden');
        }
    </script>
</body>
</html>
